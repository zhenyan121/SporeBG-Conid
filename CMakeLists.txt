cmake_minimum_required(VERSION 3.20)
project(SporeBG-Conid LANGUAGES C CXX)

# C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# è¾“å‡ºç›®å½• - ä¿®å¤é…ç½®é—®é¢˜
if(CMAKE_CONFIGURATION_TYPES OR CMAKE_BUILD_TYPE)
    set(CMAKE_RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/$<CONFIGURATION>")
    set(CMAKE_LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/$<CONFIGURATION>")
else()
    set(CMAKE_RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}")
    set(CMAKE_LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}")
endif()

include(${CMAKE_SOURCE_DIR}/cmake/ThirdParty.cmake)
include(${CMAKE_SOURCE_DIR}/cmake/SDL.cmake)

# ========== æºç  ==========
set(SOURCE_FILES
    src/main.cpp
    src/core/GameApplication.cpp
    src/core/WindowManager.cpp
    src/game/GameSession.cpp
    src/game/Board.cpp
    src/game/Piece.cpp
    src/game/Rule.cpp
    src/game/ComponentManager.cpp
    src/input/InputManager.cpp
    src/scenes/base/SceneManager.cpp
    src/scenes/gameplay/GameScene.cpp
    src/scenes/menu/MainMenuScene.cpp
    src/graphics/game/BoardRenderer.cpp
    src/graphics/game/CoordinateConverter.cpp
    src/utils/CoordinateTools.cpp
    src/graphics/font/FontManager.cpp
    src/graphics/font/TextRenderer.cpp
    src/ui/components/Button.cpp
    src/ui/components/Label.cpp
    src/ui/managers/GameUIManager.cpp
    src/ui/managers/MainMenuUIManager.cpp
    src/graphics/ui/UIRenderer.cpp
    src/graphics/font/BitmapFont.cpp
    src/utils/ConfigLoader.cpp
    src/core/DebugManager.cpp
    src/ui/managers/debug/DebugOverlay.cpp
    src/core/Time.cpp
    src/scenes/gameplay/OnlineGameScene.cpp
    src/ui/managers/OnlineGameUIManager.cpp
    src/network/client/Client.cpp
    src/network/server/GameServer.cpp
    src/network/NetworkManager.cpp
    src/graphics/texture/TextureManager.cpp
    src/scenes/other/BadAppleScene.cpp
)



add_executable(${PROJECT_NAME} ${SOURCE_FILES})





target_include_directories(${PROJECT_NAME} PRIVATE 
    ${CMAKE_SOURCE_DIR}/src
    ${asio_SOURCE_DIR}/asio/include
)

# ========== å¯ç”¨ AddressSanitizer (ä»… Debug æ¨¡å¼) ==========
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    message(STATUS "Building with AddressSanitizer enabled for target: ${PROJECT_NAME}")

    target_compile_options(${PROJECT_NAME} PRIVATE
        -fsanitize=address
        -fno-omit-frame-pointer   # ğŸ‘ˆ å¸®åŠ©ç”Ÿæˆæ›´å®Œæ•´çš„è°ƒç”¨æ ˆ
        -g                        # ğŸ‘ˆ å¿…é¡»åŠ è°ƒè¯•ç¬¦å·ï¼Œå¦åˆ™è¡Œå·ä¸å‡†
    )

    target_link_options(${PROJECT_NAME} PRIVATE
        -fsanitize=address
    )
endif()

# ========== å¹³å°ç‰¹å®šè®¾ç½® ==========
if (WIN32)
    target_compile_definitions(${PROJECT_NAME} PRIVATE
        ASIO_STANDALONE
        _WIN32_WINNT=0x0A00
    )
    
    target_link_libraries(${PROJECT_NAME}
        PRIVATE
            SDL3::SDL3
            SDL3_ttf::SDL3_ttf
            SDL3_image::SDL3_image
            nlohmann_json::nlohmann_json
            glm::glm
            ws2_32
            mswsock
            advapi32
    )
    
    # Windows: DLL å¤åˆ¶é€»è¾‘
    if(MINGW)
        # ... (ä¿æŒ MinGW DLL å¤åˆ¶é€»è¾‘)
    endif()
    
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            $<TARGET_FILE:SDL3::SDL3>
            $<TARGET_FILE_DIR:${PROJECT_NAME}>
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            $<TARGET_FILE:SDL3_ttf::SDL3_ttf>
            $<TARGET_FILE_DIR:${PROJECT_NAME}>
        COMMENT "Copying SDL3 runtime DLLs"
    )
    
else()  # Linux/macOS ç­‰ Unix-like ç³»ç»Ÿ
    target_compile_definitions(${PROJECT_NAME} PRIVATE
        ASIO_STANDALONE
    )
    
    target_link_libraries(${PROJECT_NAME}
        PRIVATE
            SDL3::SDL3
            SDL3_ttf::SDL3_ttf
            SDL3_image::SDL3_image
            nlohmann_json::nlohmann_json
            glm::glm
            pthread  # Linux éœ€è¦ pthread
            ${CMAKE_DL_LIBS}  # åŠ¨æ€é“¾æ¥åº“
    )
    
    # å¯é€‰ï¼šæ·»åŠ é¢å¤–çš„ Linux ç‰¹å®šé“¾æ¥åº“
    find_package(Threads REQUIRED)
    target_link_libraries(${PROJECT_NAME} PRIVATE Threads::Threads)
endif()

# ========== è·¨å¹³å°èµ„äº§å¤åˆ¶ ==========
set(ASSETS_SRC_DIR "${CMAKE_SOURCE_DIR}/assets")
set(ASSETS_DST_DIR "$<TARGET_FILE_DIR:${PROJECT_NAME}>/assets")

# æ”¶é›†æ‰€æœ‰ asset æ–‡ä»¶
file(GLOB_RECURSE ASSET_FILES
    "${ASSETS_SRC_DIR}/*"
)

# ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆå¤åˆ¶è§„åˆ™
foreach(ASSET_FILE ${ASSET_FILES})
    # è®¡ç®—ç›®æ ‡è·¯å¾„
    file(RELATIVE_PATH REL_PATH "${ASSETS_SRC_DIR}" "${ASSET_FILE}")
    set(OUT_FILE "${ASSETS_DST_DIR}/${REL_PATH}")
    
    add_custom_command(
        TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E make_directory
            "$<TARGET_FILE_DIR:${PROJECT_NAME}>/assets"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${ASSET_FILE}" "${OUT_FILE}"
        COMMENT "Copying changed asset: ${REL_PATH}"
    )
endforeach()
